<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hide & Seek - Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-page">
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="stars3"></div>
    
    <div class="container">
        <div class="game-logo">
            <h1 class="glitch" data-text="HIDE & SEEK">HIDE & SEEK</h1>
            <p class="subtitle">On-Chain Gaming Experience</p>
        </div>
        
        <div class="login-card">
            <div class="card-header">
                <h2>Connect Wallet</h2>
                <p>Connect with MetaMask to start playing</p>
            </div>
            
            <div class="wallet-status" id="walletStatus">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Not Connected</span>
            </div>
            
            <button class="btn-primary" id="connectBtn">
                <span class="btn-icon">ðŸ¦Š</span>
                Connect MetaMask
            </button>
            
            <div class="account-info" id="accountInfo" style="display: none;">
                <div class="info-row">
                    <span>Account:</span>
                    <span id="accountAddress" class="address"></span>
                </div>
                <div class="info-row">
                    <span>Network:</span>
                    <span id="networkName" class="network"></span>
                </div>
                <div class="info-row">
                    <span>Balance:</span>
                    <span id="accountBalance" class="balance"></span>
                </div>
            </div>
            
            <button class="btn-secondary" id="playBtn" style="display: none;">
                <span class="btn-icon">ðŸŽ®</span>
                Enter Game
            </button>
            
            <div class="error-message" id="errorMessage"></div>
        </div>
        
        <div class="game-info">
            <div class="info-card">
                <h3>ðŸŽ¯ How to Play</h3>
                <ul>
                    <li>Create or join a game</li>
                    <li>Hider: Choose a location and stake ETH</li>
                    <li>Seeker: Find the location to win</li>
                    <li>Winner takes all stakes!</li>
                </ul>
            </div>
            
            <div class="info-card">
                <h3>âš¡ Features</h3>
                <ul>
                    <li>Fully on-chain & transparent</li>
                    <li>Escrow smart contract</li>
                    <li>Base Network (Low fees)</li>
                    <li>Real-time updates</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        (function () {
            const ethersSources = [
                'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js',
                'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js'
            ];

            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = false;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to load script: ' + src));
                    document.head.appendChild(script);
                });
            }

            function loadEthers(index) {
                if (index >= ethersSources.length) {
                    return Promise.reject(new Error('Unable to load ethers.js from any source'));
                }

                const src = ethersSources[index];
                return loadScript(src)
                    .then(() => {
                        if (typeof window.ethers !== 'undefined') {
                            return;
                        }
                        console.warn(`Loaded ${src} but window.ethers is undefined. Trying next source.`);
                        return loadEthers(index + 1);
                    })
                    .catch((error) => {
                        console.warn(error.message);
                        return loadEthers(index + 1);
                    });
            }

            window.appScriptsReady = loadEthers(0)
                .then(() => loadScript('script.js'))
                .catch((error) => {
                    console.error('Failed to initialize scripts:', error);
                    throw error;
                });
        })();
    </script>
    <script>
        window.appScriptsReady
            .then(() => {
                const startLogin = () => {
                    const connectBtn = document.getElementById('connectBtn');
                    if (!connectBtn) {
                        return;
                    }

                    const playBtn = document.getElementById('playBtn');
                    const walletStatus = document.getElementById('walletStatus');
                    const statusIndicator = document.getElementById('statusIndicator');
                    const statusText = document.getElementById('statusText');
                    const accountInfo = document.getElementById('accountInfo');
                    const accountAddress = document.getElementById('accountAddress');
                    const networkName = document.getElementById('networkName');
                    const accountBalance = document.getElementById('accountBalance');
                    const errorMessage = document.getElementById('errorMessage');

                    async function initWallet() {
                        if (typeof window.ethereum === 'undefined') {
                            errorMessage.textContent = 'MetaMask not installed. Please install MetaMask.';
                            return;
                        }

                        try {
                            const provider = new ethers.providers.Web3Provider(window.ethereum);
                            const signer = provider.getSigner();
                            const address = await signer.getAddress();
                            const network = await provider.getNetwork();
                            const balance = await provider.getBalance(address);

                            statusIndicator.classList.add('connected');
                            statusText.textContent = 'Connected';
                            accountAddress.textContent = `${address.slice(0, 6)}...${address.slice(-4)}`;
                            networkName.textContent = network.name.charAt(0).toUpperCase() + network.name.slice(1);
                            accountBalance.textContent = `${ethers.utils.formatEther(balance).slice(0, 6)} ETH`;

                            accountInfo.style.display = 'block';
                            playBtn.style.display = 'block';
                            connectBtn.style.display = 'none';

                            if (network.chainId !== 8453n && network.chainId !== 84532n) {
                                errorMessage.textContent = 'Please switch to Base network (Chain ID: 8453)';
                            } else {
                                errorMessage.textContent = '';
                            }
                        } catch (error) {
                            console.error('Init error:', error);
                            errorMessage.textContent = 'Failed to initialize wallet.';
                        }
                    }

                    async function checkExistingConnection() {
                        if (typeof window.ethereum === 'undefined') {
                            return;
                        }

                        try {
                            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                            if (accounts.length > 0) {
                                await initWallet();
                            }
                        } catch (error) {
                            console.error('Error checking connection:', error);
                        }
                    }

                    connectBtn.addEventListener('click', async () => {
                        try {
                            errorMessage.textContent = '';
                            await connectWallet();
                            await initWallet();
                        } catch (error) {
                            errorMessage.textContent = error.message || 'Failed to connect wallet';
                            console.error('Connection error:', error);
                        }
                    });

                    playBtn.addEventListener('click', () => {
                        window.location.href = 'game.html';
                    });

                    checkExistingConnection();

                    if (window.ethereum) {
                        window.ethereum.on('accountsChanged', () => {
                            window.location.reload();
                        });

                        window.ethereum.on('chainChanged', () => {
                            window.location.reload();
                        });
                    }
                };

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', startLogin);
                } else {
                    startLogin();
                }
            })
            .catch((error) => {
                const showError = () => {
                    const errorMessage = document.getElementById('errorMessage');
                    if (errorMessage) {
                        errorMessage.textContent = 'Failed to load Web3 library. Please check your internet connection.';
                    }
                };

                console.error(error);

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', showError);
                } else {
                    showError();
                }
            });
    </script>
</body>
</html>

